name: ðŸš€ Deploy M365 License Optimizer to Azure

on:
  push:
    branches: [ main, lot2 ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: m365-optimizer-dev
  AZURE_LOCATION: francecentral
  POSTGRES_SERVER_NAME: m365optimizerdb
  POSTGRES_DATABASE_NAME: m365_optimizer
  POSTGRES_ADMIN_USER: adminuser
  REDIS_CACHE_NAME: m365optimizerredis
  ACR_NAME: m365optimizeracr
  WEBAPP_BACKEND_NAME: m365-optimizer-backend
  APP_SERVICE_PLAN: m365-optimizer-plan

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location ${{ env.AZURE_LOCATION }} || true

      - name: Deploy PostgreSQL Flexible Server
        run: |
          if ! az postgres flexible-server show -g ${{ env.AZURE_RESOURCE_GROUP }} -n ${{ env.POSTGRES_SERVER_NAME }} &> /dev/null; then
            az postgres flexible-server create \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.POSTGRES_SERVER_NAME }} \
              --location ${{ env.AZURE_LOCATION }} \
              --admin-user ${{ env.POSTGRES_ADMIN_USER }} \
              --admin-password "${{ secrets.POSTGRES_ADMIN_PASSWORD }}" \
              --tier Burstable \
              --sku-name Standard_B2s \
              --version 16 \
              --storage-size 128 \
              --public-access all \
              --yes
            sleep 120
          else
            echo "PostgreSQL server already exists"
          fi

      - name: Firewall Rules
        run: |
          az postgres flexible-server firewall-rule create \
            -g ${{ env.AZURE_RESOURCE_GROUP }} \
            -n ${{ env.POSTGRES_SERVER_NAME }} \
            --name AllowAllAzureIps \
            --start-ip-address 0.0.0.0 \
            --end-ip-address 255.255.255.255 || true

          IP=$(curl -s https://api.ipify.org)
          az postgres flexible-server firewall-rule create \
            -g ${{ env.AZURE_RESOURCE_GROUP }} \
            -n ${{ env.POSTGRES_SERVER_NAME }} \
            --name GitHubRunner \
            --start 0.0.0.0.0 \
            --end $IP || true

      - name: Create DB & Run init.sql (SSL forced)
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client

          psql -h ${{ env.POSTGRES_SERVER_NAME }}.postgres.database.azure.com \
               -U ${{ env.POSTGRES_ADMIN_USER }}@${{ env.POSTGRES_SERVER_NAME }} \
               -d postgres \
               --set=sslmode=require \
               -c "CREATE DATABASE \"${{ env.POSTGRES_DATABASE_NAME }}; " || true

          psql -h ${{ env.POSTGRES_SERVER_NAME }}.postgres.database.azure.com \
               -U ${{ env.POSTGRES_ADMIN_USER }}@${{ env.POSTGRES_SERVER_NAME }} \
               -d ${{ env.POSTGRES_DATABASE_NAME }} \
               --set=sslmode=require \
               -f docker/db/init.sql

      - name: Deploy Redis
        run: |
          if ! az redis show -g ${{ env.AZURE_RESOURCE_GROUP }} -n ${{ env.REDIS_CACHE_NAME }} &> /dev/null; then
          az redis create -g ${{ env.AZURE_RESOURCE_GROUP }} -n ${{ env.REDIS_CACHE_NAME }} --location ${{ env.AZURE_LOCATION }} --sku Standard --vm-size C1
          fi

      - name: Create ACR
        run: |
          if ! az acr show -g ${{ env.AZURE_RESOURCE_GROUP }} -n ${{ env.ACR_NAME }} &> /dev/null; then
            az acr create -g ${{ env.AZURE_RESOURCE_GROUP }} -n ${{ env.ACR_NAME }} --sku Standard --admin-enabled true
          fi

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build & Push Backend
        run: |
          docker build -f backend/Dockerfile -t ${{ env.ACR_NAME }}.azurecr.io/m365-optimizer-backend:latest .
          docker push ${{ env.ACR_NAME }}. azurecr.io/m365-optimizer-backend:latest

      - Deploy Backend WebApp for Containers
        run: |
          az webapp create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --plan ${{ env.APP_SERVICE_PLAN }} \
            --name ${{ env.WEBAPP_BACKEND_NAME }} \
            --deployment-container ${{ env.ACR_NAME }}.azurecr.io/m365-optimizer-backend:latest || true

          az webapp config container set -g ${{ env.AZURE_RESOURCE_GROUP }} -n ${{ env.WEBAPP_BACKEND_NAME }} \
            --docker-custom-image-name ${{ env.ACR_NAME }}.azurecr.io/m365-optimizer-backend:latest

          az webapp config appsettings set -g ${{ env.AZURE_RESOURCE_GROUP }} -n ${{ env.WEBAPP_BACKEND_NAME }} --settings \
            DATABASE_URL="postgresql://${{ env.POSTGRES_ADMIN_USER }}:${{ secrets.POSTGRES_ADMIN_PASSWORD }}@${{ env.POSTGRES_SERVER_NAME }}. postgres.database.azure.com:5432/${{ env.DATABASE_NAME }}?sslmode=require" \
            REDIS_URL="rediss://:${{ secrets.REDIS_PASSWORD }}@${{ env.REDIS_CACHE_NAME }}:6380/ssl=true"

          az webapp restart -g ${{ env.AZURE_RESOURCE_GROUP }} -n ${{ env.WEBAPP_BACKEND_NAME }}

      - Output
        run: |
          echo "Backend URL https://${{ env.WEBAPP_NAME }}.azurewebsites.net/docs"

      - Tag
        run: |
          git tag deploy-$(date +%Y%m%d-%H%M)
          git push --tags
