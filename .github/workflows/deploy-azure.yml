name: Deploy to Azure

on:
  push:
    branches: [ main, lot2 ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: m365-optimizer-dev
  AZURE_LOCATION: francecentral
  POSTGRES_SERVER_NAME: m365optimizerdb              # fixe, réutilisable
  POSTGRES_DATABASE_NAME: m365_optimizer
  POSTGRES_ADMIN_USER: adminuser
  REDIS_CACHE_NAME: m365optimizerredis                # fixe, réutilisable
  ACR_NAME: m365optimizeracr                          # fixe
  WEBAPP_BACKEND_NAME: m365-optimizer-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location ${{ env.AZURE_LOCATION }} --tags Environment=Dev || true

      - name: Deploy PostgreSQL Flexible Server
        run: |
          if ! az postgres flexible-server show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.POSTGRES_SERVER_NAME }} &> /dev/null; then
            echo "Creating PostgreSQL server..."
            az postgres flexible-server create \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.POSTGRES_SERVER_NAME }} \
              --location ${{ env.AZURE_LOCATION }} \
              --admin-user ${{ env.POSTGRES_ADMIN_USER }} \
              --admin-password "${{ secrets.POSTGRES_ADMIN_PASSWORD }}" \
              --tier Burstable \
              --sku-name Standard_B2s \
              --version 16 \
              --storage-size 128 \
              --public-access 0.0.0.0-255.255.255.255 \
              --yes
          else
            echo "PostgreSQL server already exists"
          fi

      - name: Configure PostgreSQL Firewall
        run: |
          az postgres flexible-server firewall-rule create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.POSTGRES_SERVER_NAME }} \
            --rule-name AllowAzureServices \
            --start-ip-address 0.0.0.0 \
            --end-ip-address 0.0.0.0 || true
          
          GITHUB_IP=$(curl -s https://api.ipify.org)
          az postgres flexible-server firewall-rule create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.POSTGRES_SERVER_NAME }} \
            --rule-name GitHubActions \
            --start-ip-address $GITHUB_IP \
            --end-ip-address $GITHUB_IP || true

      - name: Create Database & Initialize Schema
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client
          until psql -h ${{ env.POSTGRES_SERVER_NAME }}.postgres.database.azure.com -U ${{ env.POSTGRES_ADMIN_USER }}@${{ env.POSTGRES_SERVER_NAME }} -d postgres -c "SELECT 1"; do
            echo "Waiting for PostgreSQL...
            sleep 5
          done
          
          psql -h ${{ env.POSTGRES_SERVER_NAME }}.postgres.database.azure.com -U ${{ env.POSTGRES_ADMIN_USER }}@${{ env.POSTGRES_SERVER_NAME }} -d postgres -c "CREATE DATABASE ${{ env.POSTGRES_DATABASE_NAME }};" || true
          
          psql -h ${{ env.POSTGRES_SERVER_NAME }}.postgres.database.azure.com -U ${{ env.POSTGRES_ADMIN_USER }}@${{ env.POSTGRES_SERVER_NAME }} -d ${{ env.POSTGRES_DATABASE_NAME }} \
            -f docker/db/init.sql --set=sslmode=require

      - name: Deploy Redis Cache
        run: |
          if ! az redis show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.REDIS_CACHE_NAME }} &> /dev/null; then
            az redis create \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.REDIS_CACHE_NAME }} \
              --location ${{ env.AZURE_LOCATION }} \
              --sku Standard \
              --vm-size C1
          fi

      - name: Create Azure Container Registry
        run: |
          if ! az acr show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.ACR_NAME }} &> /dev/null; then
            az acr create \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.ACR_NAME }} \
              --sku Standard \
              --admin-enabled true
          fi

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build & Push Backend Image
        run: |
          docker build -f backend/Dockerfile -t ${{ env.ACR_NAME }}.azurecr.io/m365-optimizer-backend:latest .
          docker push ${{ env.ACR_NAME }}.azurecr.io/m365-optimizer-backend:latest

      - name: Deploy Backend App Service (Container)
        run: |
          az webapp create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --plan m365-optimizer-plan \
            --name ${{ env.WEBAPP_BACKEND_NAME }} \
            --deployment-container-image-name ${{ env.ACR_NAME }}.azurecr.io/m365-optimizer-backend:latest || true
          
          az webapp config container set \
            --name ${{ env.WEBAPP_BACKEND_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --docker-registry-server-url https://${{ env.ACR_NAME }}.azurecr.io \
            --docker-registry-server-user ${{ env.ACR_NAME }} \
            --docker-registry-server-password $(az acr credential show --name ${{ env.ACR_NAME }} --query passwords[0].value -o tsv)
          
          az webapp config appsettings set \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.WEBAPP_BACKEND_NAME }} \
            --settings \
              DATABASE_URL="postgresql://${{ env.POSTGRES_ADMIN_USER }}:${{ secrets.POSTGRES_ADMIN_PASSWORD }}@${{ env.POSTGRES_SERVER_NAME }}.postgres.database.azure.com:5432/${{ env.POSTGRES_DATABASE_NAME }}?sslmode=require" \
              REDIS_URL="rediss://${{ env.REDIS_CACHE_NAME }}.redis.cache.windows.net:6380,password=$(az redis list-keys --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.REDIS_CACHE_NAME }} --query primaryKey -o tsv),ssl=True" \
              WEBSITES_PORT=8000
          
          az webapp restart --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.WEBAPP_BACKEND_NAME }}

      - name: Output URLs
        run: |
          echo "=================================="
          echo "DÉPLOIEMENT RÉUSSI"
          echo "=================================="
          echo "Backend : https://${{ env.WEBAPP_BACKEND_NAME }}.azurewebsites.net"
          echo "Swagger : https://${{ env.WEBAPP_BACKEND_NAME }}.azurewebsites.net/docs"
          echo "Postgres : ${{ env.POSTGRES_SERVER_NAME }}.postgres.database.azure.com"
          echo "Redis : ${{ env.REDIS_CACHE_NAME }}.redis.cache.windows.net"

      - name: Tag deployment
        run: |
          TAG="deploy-$(date +%Y%m%d-%H%M)"
          git tag $TAG
          git push origin $TAG || true
