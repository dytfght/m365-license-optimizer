name: Deploy to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: m365-optimizer-dev
  AZURE_LOCATION: francecentral
  POSTGRES_SERVER_NAME: m365optimizerdb
  POSTGRES_DATABASE_NAME: m365_optimizer
  POSTGRES_ADMIN_USER: adminuser
  REDIS_CACHE_NAME: m365optimizerredis

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }} \
            --tags Environment=Development Project=M365LicenseOptimizer

      - name: Deploy PostgreSQL Server
        run: |
          # Check if server exists
          if ! az postgres flexible-server show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.POSTGRES_SERVER_NAME }} &> /dev/null; then

            echo "Creating PostgreSQL flexible server..."
            az postgres flexible-server create \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.POSTGRES_SERVER_NAME }} \
              --location ${{ env.AZURE_LOCATION }} \
              --admin-user adminuser \
              --admin-password "${{ secrets.POSTGRES_ADMIN_PASSWORD }}" \
              --sku-name Standard_B1ms \
              --tier Burstable \
              --version 17 \
              --storage-size 32 \
              --backup-retention 7 \
              --tags Environment=Development Project=M365LicenseOptimizer \
              --yes
          else
            echo "PostgreSQL server already exists"
          fi

      - name: Configure PostgreSQL Firewall
        run: |
          # Allow Azure services
          az postgres flexible-server firewall-rule create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.POSTGRES_SERVER_NAME }} \
            --rule-name AllowAzureServices \
            --start-ip-address 0.0.0.0 \
            --end-ip-address 0.0.0.0 || true

          # Get current GitHub Actions IP
          GITHUB_IP=$(curl -s https://api.ipify.org)
          echo "GitHub Actions IP: $GITHUB_IP"

          # Allow GitHub Actions IP
          az postgres flexible-server firewall-rule create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.POSTGRES_SERVER_NAME }} \
            --rule-name AllowGitHubActions \
            --start-ip-address $GITHUB_IP \
            --end-ip-address $GITHUB_IP || true

          # Wait for firewall rules to be applied
          sleep 30

      - name: Create PostgreSQL Database
        run: |
          az postgres flexible-server db create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --server-name ${{ env.POSTGRES_SERVER_NAME }} \
            --database-name m365_optimizer || true

      - name: Initialize PostgreSQL Schema
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        run: |
          # Install PostgreSQL client
          sudo apt-get update
          sudo apt-get install -y postgresql-client

          # Run initialization script
          psql \
            -h ${{ env.POSTGRES_SERVER_NAME }}.postgres.database.azure.com \
            -U adminuser \
            -d m365_optimizer \
            -f docker/db/init.sql \
            --set=sslmode=require || echo "Schema might already exist"

      - name: Deploy Redis Cache
        run: |
          # Check if Redis cache exists
          if ! az redis show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.REDIS_CACHE_NAME }} &> /dev/null; then

            echo "Creating Redis Cache..."
            az redis create \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.REDIS_CACHE_NAME }} \
              --location ${{ env.AZURE_LOCATION }} \
              --sku Basic \
              --vm-size c0 \
              --tags Environment=Development Project=M365LicenseOptimizer

            # Configure non-SSL port separately (if needed)
            az redis update \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.REDIS_CACHE_NAME }} \
              --set enableNonSslPort=false || true
          else
            echo "Redis cache already exists"
          fi

      - name: Configure Redis Settings
  run: |
    # Wait for Redis to be ready
    echo "Waiting for Redis to be fully provisioned..."
    sleep 60
    
    # Check if Redis is ready
    for i in {1..10}; do
      if az redis show \
        --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
        --name ${{ env.REDIS_CACHE_NAME }} \
        --query provisioningState -o tsv | grep -q "Succeeded"; then
        echo "Redis is ready!"
        break
      else
        echo "Attempt $i/10: Redis still provisioning, waiting 30 seconds..."
        sleep 30
      fi
    done
    
    # Configure patch schedule (optional)
    echo "Configuring maintenance schedule..."
    az redis patch-schedule create \
      --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
      --name ${{ env.REDIS_CACHE_NAME }} \
      --schedule-entries '[{
        "dayOfWeek": "Sunday",
        "startHourUtc": 2,
        "maintenanceWindow": "PT5H"
      }]' 2>/dev/null || echo "Patch schedule configuration skipped (may already exist)"
    
    # Get Redis information
    echo "Redis Cache Information:"
    az redis show \
      --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
      --name ${{ env.REDIS_CACHE_NAME }} \
      --query '{name:name,hostName:hostName,port:port,sslPort:sslPort,provisioningState:provisioningState}' \
      --output table

      - name: Get Connection Strings
        run: |
          echo "==================================="
          echo "Azure Resources Deployed Successfully"
          echo "==================================="
          
          echo "PostgreSQL Connection:"
          echo "Host: ${{ env.POSTGRES_SERVER_NAME }}.postgres.database.azure.com"
          echo "Database: m365_optimizer"
          echo "User: adminuser@${{ env.POSTGRES_SERVER_NAME }}"
          echo "SSL: Required"
          
          echo ""
          echo "Redis Connection:"
          REDIS_HOST=$(az redis show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.REDIS_CACHE_NAME }} \
            --query hostName -o tsv)
          echo "Host: $REDIS_HOST"
          echo "Port: 6380 (SSL)"
          
          echo ""
          echo "To get Redis access key, run:"
          echo "az redis list-keys --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.REDIS_CACHE_NAME }}"

      - name: Tag Deployment
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          TAG_NAME="deployment-$(date +%Y%m%d-%H%M%S)"
          git tag -a $TAG_NAME -m "Deployed to Azure: ${{ env.AZURE_RESOURCE_GROUP }}"
          git push origin $TAG_NAME || true

  test-deployment:
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Test PostgreSQL Connection
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          
          echo "Testing PostgreSQL connection..."
          psql \
            -h ${{ env.POSTGRES_SERVER_NAME }}.postgres.database.azure.com \
            -U adminuser \
            -d m365_optimizer \
            -c "SELECT 1 as test_connection;" \
            --set=sslmode=require

      - name: Test Redis Connection
        run: |
          sudo apt-get install -y redis-tools
          
          REDIS_KEY=$(az redis list-keys \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.REDIS_CACHE_NAME }} \
            --query primaryKey -o tsv)
          
          REDIS_HOST=${{ env.REDIS_CACHE_NAME }}.redis.cache.windows.net
          
          echo "Testing Redis connection..."
          redis-cli -h $REDIS_HOST -p 6380 --tls -a $REDIS_KEY PING

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "All infrastructure components are ready."
          echo ""
          echo "Next steps:"
          echo "1. Update .env with Azure connection strings"
          echo "2. Deploy backend application (Lot 2)"
          echo "3. Deploy frontend application (Lot 12)"
